<div class="page-layout doc-layout">
  <!-- 文档侧边栏 -->
  <%- partial('_partial/doc-sidebar') %>

  <!-- 文档主内容 -->
  <article class="doc-article">
    <!-- 文档头部 -->
    <header class="doc-header">
      <h1 class="doc-title"><%= page.title %></h1>
      
      <!-- 文档元信息 -->
      <div class="doc-meta">
        <% if (theme.post.word_count) { %>
          <span class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 6.1H3"></path>
              <path d="M21 12.1H3"></path>
              <path d="M15.1 18H3"></path>
            </svg>
            <% 
              const content = strip_html(page.content);
              const wordCount = content.length;
              const displayCount = wordCount >= 1000 ? (wordCount / 1000).toFixed(1) + 'k' : wordCount;
            %>
            <%= displayCount %> 字
          </span>
        <% } %>
        
        <% if (theme.post.reading_time) { %>
          <span class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <% 
              const wpm = theme.post.words_per_minute || 300;
              const text = strip_html(page.content);
              const minutes = Math.ceil(text.length / wpm);
            %>
            约 <%= minutes %> 分钟阅读
          </span>
        <% } %>

        <% if (page.updated) { %>
          <span class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
              <path d="M21 3v5h-5"></path>
            </svg>
            更新于 <%= date(page.updated, 'YYYY-MM-DD') %>
          </span>
        <% } %>
      </div>
    </header>

    <!-- 文档内容 -->
    <div class="doc-content markdown-body">
      <%- page.content %>
    </div>

    <!-- 文档导航 -->
    <nav class="doc-nav">
      <%
        // 查找当前文档在配置中的位置
        function findDocNav(docs, currentPath, parent = null, prevDoc = null) {
          let result = { prev: null, next: null };
          let foundCurrent = false;
          
          for (let i = 0; i < docs.length; i++) {
            const doc = docs[i];
            
            if (doc.children) {
              const childResult = findDocNav(doc.children, currentPath, doc, prevDoc);
              if (childResult.found) {
                return childResult;
              }
              // 获取最后一个子文档作为 prevDoc
              const lastChild = doc.children[doc.children.length - 1];
              prevDoc = lastChild.children ? null : lastChild;
            } else {
              if (doc.path === currentPath) {
                result.prev = prevDoc;
                // 查找下一个
                if (i + 1 < docs.length) {
                  const nextDoc = docs[i + 1];
                  result.next = nextDoc.children ? nextDoc.children[0] : nextDoc;
                }
                result.found = true;
                return result;
              }
              prevDoc = doc;
            }
          }
          
          return result;
        }
        
        const docNav = theme.docs ? findDocNav(theme.docs, page.path) : {};
      %>
      
      <% if (docNav.prev) { %>
        <a href="<%- url_for(docNav.prev.path) %>" class="doc-nav-item prev">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6"></path>
          </svg>
          <div class="doc-nav-text">
            <span class="doc-nav-label">上一篇</span>
            <span class="doc-nav-title"><%= docNav.prev.title %></span>
          </div>
        </a>
      <% } else { %>
        <div class="doc-nav-item prev disabled"></div>
      <% } %>
      
      <% if (docNav.next) { %>
        <a href="<%- url_for(docNav.next.path) %>" class="doc-nav-item next">
          <div class="doc-nav-text">
            <span class="doc-nav-label">下一篇</span>
            <span class="doc-nav-title"><%= docNav.next.title %></span>
          </div>
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m9 18 6-6-6-6"></path>
          </svg>
        </a>
      <% } else { %>
        <div class="doc-nav-item next disabled"></div>
      <% } %>
    </nav>
  </article>

  <!-- 文档 TOC -->
  <% if (theme.toc.enable && page.toc !== false) { %>
    <aside class="doc-toc">
      <div class="toc-wrapper">
        <h3 class="toc-title">本页目录</h3>
        <div class="toc-content">
          <%- toc(page.content, { list_number: theme.toc.number, max_depth: theme.toc.max_depth }) %>
        </div>
      </div>
    </aside>
  <% } %>
</div>

<!-- 移动端侧边栏切换按钮 -->
<button class="doc-sidebar-toggle" aria-label="切换目录">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M3 9h18"></path>
    <path d="M3 15h18"></path>
  </svg>
</button>
